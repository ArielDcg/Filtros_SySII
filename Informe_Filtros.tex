\documentclass[12pt, a4paper, spanish]{article}

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[spanish]{babel}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{geometry}
\usepackage{fancyhdr}
\usepackage{array}
\usepackage{booktabs}
\usepackage{float}
\usepackage{subcaption}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{hyperref}

% Configuración de márgenes
\geometry{
    top=2.5cm,
    bottom=2.5cm,
    left=2.5cm,
    right=2.5cm
}

% Configuración de encabezados
\pagestyle{fancy}
\fancyhf{}
\rhead{Proyecto de Filtros}
\lhead{Sistemas y Señales II}
\cfoot{\thepage}

% Configuración de listings para código
\lstset{
    basicstyle=\ttfamily\small,
    keywordstyle=\color{blue},
    commentstyle=\color{gray},
    stringstyle=\color{red},
    breaklines=true,
    showspaces=false,
    showstringspaces=false,
    frame=single,
    rulecolor=\color{black},
    backgroundcolor=\color{white!95!black}
}

\title{\textbf{\Huge Diseño e Implementación de un Ecualizador de Audio de 4 Bandas} \\
\textbf{\large Filtros Analógicos, IIR y FIR} \\
\vspace{1cm}
\textbf{Sistemas y Señales II}}

\author{
    \textbf{Autor 1}\\
    Johan Arturo Barajas Herrera\\
    \texttt{jbarajash@unal.edu.co}\\
    \vspace{0.5cm}
    \and
    \textbf{Autor 2}\\
    Ariel Giovanni Cardenas Santisteban\\
    \texttt{arcardenass@unal.edu.co}\\
    \vspace{0.5cm}
    \and
    \textbf{Autor 3}\\
    Dilan Santiago Porras Cortés\\
    \texttt{diporrasc@unal.edu.co}
}


\date{\today}

\begin{document}

\maketitle

\begin{abstract}
\noindent
Este informe presenta el diseño e implementación de tres tipos fundamentales de filtros digitales y analógicos:
filtros analógicos (Butterworth), filtros IIR (Infinite Impulse Response) y filtros FIR (Finite Impulse Response).
Se describe el procedimiento de diseño, se muestran las funciones de transferencia, y se analizan las respuestas
en frecuencia (magnitud y fase) de cada filtro mediante diagramas de Bode. Los filtros se implementaron en MATLAB
usando funciones estándar y sus características se validan mediante el análisis de sus especificaciones técnicas.
\end{abstract}

\newpage

\tableofcontents

\newpage

\section{Especificaciones del Sistema}

\subsection{Parámetros Generales}

El sistema implementa un ecualizador digital de 4 bandas de frecuencia con especificaciones:

\begin{table}[H]
\centering
\begin{tabular}{|l|c|}
\hline
\textbf{Parámetro} & \textbf{Valor} \\
\hline
Frecuencia de Muestreo ($F_s$) & 64000 Hz \\
\hline
Número de Bandas & 4 \\
\hline
Atenuación Banda de Paso ($A_p$) & 3 dB \\
\hline
Atenuación Banda de Rechazo ($A_s$) & 15 dB \\
\hline
Tipo de Filtros & Butterworth \\
\hline
\end{tabular}
\caption{Especificaciones Generales del Sistema}
\label{tab:spec_general}
\end{table}

\subsection{Cálculo de Frecuencias}

Las frecuencias centrales de las 4 bandas del ecualizador son:

\begin{equation}
f_{\text{central}} = [102.4, 512, 2560, 12800] \text{ Hz}
\end{equation}

Las frecuencias de corte se calculan mediante:

\begin{align*}
f_{\text{corte}}(i) &= \sqrt{f_{\text{central}}(i-1) \cdot f_{\text{central}}(i)} \quad \text{para } i = 2, 3, 4 
\end{align*}


\begin{table}[H]
\centering
\begin{tabular}{|c|c|c|c|}
\hline
\textbf{Banda} & \textbf{Tipo} & \textbf{f\_Corte (Hz)} & \textbf{f\_Central (Hz)} \\
\hline
1 & Pasabajos & 228.70 & 102.4 \\
\hline
2 & Pasabanda & 228.70 - 1143.55 & 512 \\
\hline
3 & Pasabanda & 1143.55 - 5726.81 & 2560 \\
\hline
4 & Pasaaltos & 5726.81 - 28618.37 & 12800 \\
\hline
\end{tabular}
\caption{Bandas de Frecuencia del Ecualizador}
\label{tab:bands}
\end{table}

\newpage

\section{Diseño de Filtros Analógicos}

\subsection{Cálculo de Orden}

Utilizando la función \texttt{buttord}, se determina el orden mínimo requerido para cumplir las especificaciones en cada banda:

\begin{equation*}
[n, W_n] = \text{buttord}(W_p, W_s, A_p, A_s, \text{'s'})
\end{equation*}

\subsubsection{Banda 1: Pasabajos}

\begin{align*}
\omega_{p1} &= 2\pi f_{\text{corte}}(2) = 2\pi \times 228.70 = 1436.74 \text{ rad/s} \\
\omega_{s1} &= 2\pi f_{\text{central}}(1) = 2\pi \times 102.4 = 643.41 \text{ rad/s}
\end{align*}

% Pilas: Insertar orden calculado n1 y W_n1

\subsubsection{Banda 2: Pasabanda}

\begin{align*}
\omega_{p2} &= 2\pi [f_{\text{corte}}(2), f_{\text{corte}}(3)] \text{ rad/s} \\
\omega_{s2} &= 2\pi [f_{\text{central}}(1), f_{\text{central}}(3)] \text{ rad/s}
\end{align*}

\subsubsection{Banda 3: Pasabanda}

\begin{align*}
\omega_{p3} &= 2\pi [f_{\text{corte}}(3), f_{\text{corte}}(4)] \text{ rad/s} \\
\omega_{s3} &= 2\pi [f_{\text{central}}(2), f_{\text{central}}(4)] \text{ rad/s}
\end{align*}

\subsubsection{Banda 4: Pasaaltos}

\begin{align*}
\omega_{p4} &= 2\pi f_{\text{corte}}(4) = 2\pi \times 5726.81 = 35962.84 \text{ rad/s} \\
\omega_{s4} &= 2\pi f_{\text{central}}(3) = 2\pi \times 2560 = 16085.29 \text{ rad/s}
\end{align*}

% Pilas: Insertar orden calculado n4 y W_n4

El orden máximo entre todas las bandas se utiliza para todos los filtros analógicos:

\begin{equation*}
n_{\max\_analog} = \max(n_1, n_2, n_3, n_4) = 3 \text{ Pasabajos y Pasaltos } \text{ - } 6 \text{ Pasabandas}
\end{equation*}

\subsection{Función de Transferencia}

La función de transferencia se obtiene mediante:

\begin{equation*}
[num, den] = \text{butter}(n_{\max}, W_n, \text{tipo}, \text{'s'})
\end{equation*}

donde \textit{tipo} es 'low' para pasabajos, 'bandpass' para pasabanda, y 'high' para pasaaltos.

% Pilas: Insertar código MATLAB utilizado para diseño analógico

\newpage

\section{Diseño de Filtros IIR (Transformación Bilineal)}

\subsection{Normalización de Frecuencias}

Las frecuencias se normalizan respecto a la frecuencia de Nyquist:

\begin{equation}
w_n = \frac{f}{F_s/2}, \quad F_{\text{Nyquist}} = \frac{F_s}{2} = 32000 \text{ Hz}
\end{equation}

\subsubsection{Banda 1: Pasabajos}
*
\begin{align*}
w_{p1} &= \frac{f_{\text{corte}}(2)}{32000} = \frac{228.70}{32000} = 0.00715 \\
w_{s1} &= \frac{f_{\text{central}}(1)}{32000} = \frac{102.4}{32000} = 0.00320
\end{align*}

\subsubsection{Banda 2: Pasabanda}

\begin{align*}
w_{p2} &= \frac{[228.70, 1143.55]}{32000} = [0.00715, 0.03573] \\
w_{s2} &= \frac{[102.4, 2560]}{32000} = [0.00320, 0.08000]
\end{align*}

\subsubsection{Banda 3: Pasabanda}

\begin{align*}
w_{p3} &= \frac{[1143.55, 5726.81]}{32000} = [0.03573, 0.17896] \\
w_{s3} &= \frac{[512, 12800]}{32000} = [0.01600, 0.40000]
\end{align*}

\subsubsection{Banda 4: Pasaaltos}

\begin{align*}
w_{p4} &= \frac{f_{\text{corte}}(4)}{32000} = \frac{5726.81}{32000} = 0.17896 \\
w_{s4} &= \frac{f_{\text{central}}(3)}{32000} = \frac{2560}{32000} = 0.08000
\end{align*}

\subsection{Cálculo de Orden Digital}

\begin{equation*}
[n, W_n] = \text{buttord}(w_p, w_s, A_p, A_s)
\end{equation*}

% Pilas: Insertar órdenes calculados n_iir(1) a n_iir(4)

El orden máximo se asigna a todos los filtros:

\begin{equation*}
n_{\max\_iir} = \max(n_{\text{iir,1}}, n_{\text{iir,2}}, n_{\text{iir,3}}, n_{\text{iir,4}}) = 3 \text{ Pasabajos y Pasaltos } \text{ - } 6 \text{ Pasabandas}
\end{equation*}

\subsection{Diseño Digital}

\begin{equation}
[num, den] = \text{butter}(n_{\max\_iir}, W_n, \text{tipo})
\end{equation}

% Pilas: Insertar código MATLAB utilizado para diseño IIR Bilineal

\newpage

\section{Diseño de Filtros IIR (Invarianza al Impulso)}

\subsection{Principio de Invarianza al Impulso}

El método de invarianza al impulso convierte un filtro analógico a uno digital haciendo que la respuesta al impulso del filtro digital sea una versión muestreada de la respuesta al impulso analógico:

\begin{equation}
h_d[n] = T \cdot h_a(nT), \quad n = 0, 1, 2, \ldots
\end{equation}

donde $T = 1/F_s$ es el período de muestreo.

\subsection{Ventajas de Invarianza al Impulso}

\begin{itemize}
    \item Preserva exactamente la respuesta al impulso del filtro analógico en los instantes de muestreo.
    \item Mantiene la estabilidad: si el filtro analógico es estable, el digital también lo será.
    \item Adecuado para filtros con respuestas al impulso cortas (como Butterworth).
\end{itemize}

\subsection{Cálculo de Orden}

Para invarianza al impulso, se utiliza el mismo análisis de orden que para el diseño analógico:

\begin{equation}
n_{\max\_inv} = \max(n_{\text{analog}}, n_{\text{inv},4}) = 3
\end{equation}

\subsection{Implementación en MATLAB}

La conversión de filtros analógicos a digitales mediante invarianza al impulso se realiza usando:

\begin{equation}
[\text{num}_d, \text{den}_d] = \text{impinvar}(\text{num}_a, \text{den}_a, F_s)
\end{equation}

% Pilas: Insertar código MATLAB utilizado para diseño IIR Invarianza

\newpage

\section{Diseño de Filtros FIR (Ventana Hamming)}

\subsection{Cálculo de Orden}

El orden se calcula basado en el ancho de la banda de transición:

\begin{equation}
M = \text{ceil}\left(\frac{3.3 \times F_s}{\Delta f}\right)
\end{equation}

donde $\Delta f$ es el ancho de la banda de transición.

\subsubsection{Banda 1: Pasabajos}

\begin{align*}
\Delta f_1 &= |f_{\text{central}}(1) - f_{\text{corte}}(2)| = |102.4 - 228.70| = 126.30 \text{ Hz} \\
M_1 &= \text{ceil}\left(\frac{3.3 \times 64000}{126.30}\right) = 747
\end{align*}

Si $M$ es par, se incrementa en 1. Límite máximo: 1000 coeficientes.

\subsubsection{Banda 2: Pasabanda}

\begin{align*}
\Delta f_2 &= \min(|f_{\text{corte}}(2) - f_{\text{central}}(1)|, |f_{\text{central}}(3) - f_{\text{corte}}(3)|) \\
&= \min(|228.70 - 102.4|, |2560 - 1143.55|) = 126.30 \text{ Hz} \\
M_2 &= 1001
\end{align*}

\subsubsection{Banda 3: Pasabanda}

\begin{align*}
\Delta f_3 &= \min(|f_{\text{corte}}(3) - f_{\text{central}}(2)|, |f_{\text{central}}(4) - f_{\text{corte}}(4)|) \\
&= \min(|1143.55 - 512|, |12800 - 5726.81|) = 631.55 \text{ Hz} \\
M_3 &= 335
\end{align*}

\subsubsection{Banda 4: Pasaaltos}

\begin{align*}
\Delta f_4 &= |f_{\text{corte}}(4) - f_{\text{central}}(3)| = |5726.81 - 2560| = 3166.81 \text{ Hz} \\
M_4 &= 67
\end{align*}

\subsection{Ventana de Hamming}

\begin{equation}
w[n] = 0.54 - 0.46 \cos\left(\frac{\pi (n+M)}{M
}\right), \quad n = -M, \ldots, -1, 0, 1, \ldots, M
\end{equation}

\subsection{Diseño FIR}

\begin{equation}
h[n] = w[n] \cdot h_d[n]
\end{equation}

donde $h_d[n]$ son los coeficientes ideales calculados mediante:

\begin{equation}
num = \text{fir1}(M-1, W_n, \text{tipo}, \text{hamming}(M))
\end{equation}

\section{Respuesta en Frecuencia}

\subsection{Comparación de Magnitud - Todas las Bandas}

% Pilas: Insertar gráfica de comparación de magnitud (4 subplots, uno por banda)
% Mostrar respuesta de Analógico, IIR y FIR juntos en cada subplot

\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{images/comparacionMagnitud.png}
\caption{Respuesta en Magnitud - Comparación de los Tres Métodos}
\label{fig:mag_comparison}
\end{figure}


% Pilas: Verificar que todos los filtros cumplen con A_p = -3 dB en banda de paso y A_s = -15 dB en banda de rechazo

\subsection{Respuesta del Sistema Completo}

El sistema completo resulta de la combinación en paralelo de los 4 filtros de cada tipo.

% Pilas: Insertar gráfica de respuesta completa del sistema (3 subplots para Analógico, IIR, FIR)

\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{images/sistemaCompleto.png}
\caption{Respuesta del Sistema Analógico, IIR y FIR}
\label{fig:sys_complete}
\end{figure}



\subsection{Respuesta en Fase}

% Pilas: Insertar gráfica de fase (4 subplots, uno por banda)
% Mostrar Analógico, IIR y FIR en cada subplot

\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{images/respuestaFase.png}
\caption{Respuesta en Fase - Todos los Métodos}
\label{fig:phase}
\end{figure}



% Pilas: Anotar el comportamiento de fase lineal del FIR vs distorsión de fase del Analógico e IIR

\newpage

\section{Verificación de Especificaciones}

% Pilas: Insertar gráfica de cumplimiento de especificaciones (detalle de una banda con marcas de -3dB y -15dB)

\begin{figure}[H]
\centering
\includegraphics[width=0.85\linewidth]{images/verificacionAnalogo.png}
\caption{Verificación de Especificaciones por Banda. Sistema análogo.}
\label{fig:spec_verify}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.85\linewidth]{images/verificacionBilineal.png}
    \caption{Verificación de Especificaciones por Banda. Sistema IIR bilineal.}
    \label{fig:placeholder}
\end{figure}


\begin{figure}[H]
    \centering
    \includegraphics[width=0.85\linewidth]{images/verificacionInvar.png}
    \caption{Verificación de Especificaciones por Banda. Sistema IIR por invarianza del impulso.}
    \label{fig:placeholder}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.85\linewidth]{images/verificacionFir.png}
    \caption{Verificación de Especificaciones por Banda. Sistema FIR.}
    \label{fig:placeholder}
\end{figure}





\section{Análisis Espectral de Audio}

\subsection{Procesamiento de Señal}

La señal de entrada se procesa mediante los tres sistemas del ecualizador. Para cada banda se calcula:

\begin{enumerate}
    \item \textbf{Sistema Analógico}: Simulación mediante \texttt{lsim} con espacio de estados
    \item \textbf{Sistema IIR}: Filtrado directo con \texttt{filter}
    \item \textbf{Sistema FIR}: Convolución digital con \texttt{filter}
\end{enumerate}

La salida total de cada sistema es:

\begin{equation}
y_{\text{total}}[n] = \sum_{i=1}^{4} G_i \times y_i[n]
\end{equation}

donde $G_i$ es la ganancia de la banda $i$ (por defecto $G_i = 1$).

\subsection{Espectro de Entrada vs Salida}

% Pilas: Insertar gráfica de espectro entrada vs salida total (escala log, 3 gráficas para Analógico, IIR, FIR)


\begin{figure}[H]
    \centering
    \includegraphics[width=0.85\linewidth]{images/audioComparacion.png}
    \caption{Análisis Espectral: Entrada vs Salida. Comparación de todos los sistemas.}
    \label{fig:placeholder}
\end{figure}



\subsection{Análisis por Banda}

% Pilas: Insertar gráficas de espectro individual por banda (sistema analógico)

\begin{figure}[H]
    \centering
    \includegraphics[width=0.85\linewidth]{images/audioAnalogo.png}
    \caption{Espectro por banda. Sistema análogo.}
    \label{fig:placeholder}
\end{figure}

\begin{figure}[H]
\centering
\fbox{\begin{minipage}[c][8cm]{0.95\textwidth}
Espectro Individual por Banda - Sistema Analógico\\
6 subplots: entrada + 4 bandas individuales
\end{minipage}}
\caption{Análisis Espectral Bandas - Sistema Analógico}
\label{fig:bands_analog}
\end{figure}

% Pilas: Insertar gráficas de espectro individual por banda (sistema IIR)

\begin{figure}[H]
\centering
\fbox{\begin{minipage}[c][8cm]{0.95\textwidth}
Espectro Individual por Banda - Sistema IIR\\
6 subplots: entrada + 4 bandas individuales
\end{minipage}}
\caption{Análisis Espectral Bandas - Sistema IIR}
\label{fig:bands_iir}
\end{figure}

% Pilas: Insertar gráficas de espectro individual por banda (sistema FIR)

\begin{figure}[H]
\centering
\fbox{\begin{minipage}[c][8cm]{0.95\textwidth}
Espectro Individual por Banda - Sistema FIR\\
6 subplots: entrada + 4 bandas individuales
\end{minipage}}
\caption{Análisis Espectral Bandas - Sistema FIR}
\label{fig:bands_fir}
\end{figure}

\newpage

\section{Resultados Numéricos}

\subsection{Órdenes de Filtros Calculados}

% Pilas: Completar tabla con órdenes calculados por buttord para cada banda

\begin{table}[H]
\centering
\begin{tabular}{|l|c|c|c|c|}
\hline
\textbf{Banda} & \textbf{Analógico} & \textbf{IIR (Bilineal)} & \textbf{IIR (Invar)} & \textbf{FIR} \\
\hline
1 (Pasabajos, 102.4 Hz) & 3 & 3 & 3 & 746 coef. \\
\hline
2 (Pasabanda, 512 Hz) & 3 & 3 & 3 & 999 coef. \\
\hline
3 (Pasabanda, 2560 Hz) & 3 & 3 & 3 & 334 coef. \\
\hline
4 (Pasaaltos, 12800 Hz) & 3 & 3 & 3 & 66 coef. \\
\hline
\textbf{Orden Máximo} & \textbf{3} & \textbf{3} & \textbf{3} & \textbf{999} \\
\hline
\end{tabular}
\caption{Órdenes de los Filtros Diseñados}
\label{tab:filter_orders}
\end{table}

%\subsection{Características de Estabilidad}

% Pilas: Para IIR, verificar que todos los polos están dentro del círculo unitario
% Pilas: Para Analógico, verificar que todos los polos están en semiplano izquierdo
% Pilas: Para FIR, mencionar que es garantizado por diseño

%\subsubsection{Análisis de Polos y Ceros}

%\begin{table}[H]
%\centering
%\begin{tabular}{|l|c|c|}
%\hline
%\textbf{Sistema} & \textbf{Número de Polos} & \textbf{Número de Ceros} \\
%\hline
%Analógico Banda 1 & [Pilas] & [Pilas] \\
%\hline
%IIR Banda 1 & [Pilas] & [Pilas] \\
%\hline
%FIR Banda 1 & 0 (orden digital) & [Pilas] \\
%\hline
%\end{tabular}
%\caption{Características de Polos y Ceros - Banda 1}
%\label{tab:poles_zeros}
%\end{table}

\section{Normalización y Procesamiento de Audio}

\subsection{Normalización de Señal}

Después del procesamiento, se normaliza la señal para evitar saturación:

\begin{equation}
\text{Si } \max(|y|) > 1 \rightarrow y_{\text{norm}} = \frac{y}{\max(|y|)}
\end{equation}

% Pilas: Insertar factor de normalización utilizado en cada sistema


\subsection{Filtros analógicos}
Un filtro analógico se puede expresar con una función de transferencia de la forma:

\begin{equation}
    H(s) = \frac{b_0s^m+b_1s^{m-1}+...+b_{m-1}s+b_m}{a_0s^n+a_1s^{n-1}+...+a_{n-1}s+a_n}
\end{equation}
Cuyo orden $N$ es el mayor entre $n$ y $m$. Es posible escribirse a partir de sus residuos ($r_i$), polos ($p_i$) y ganancia ($k(s)$).
\begin{equation}
    H(s) = k(s) + \frac{r_2}{s-p_1} + \frac{r_2}{s-p_2} + ... + \frac{r_{N-1}}{s-p_{N-1}} + \frac{r_N}{s-p_N}
\end{equation}
El resultado es un suma de fracciones de orden 1, lo cual es puede traducir a conectar en paralelos varios sistemas de orden 1.

\subsection{Filtros IIR}
De manera similar, un filtro digital IIR puede expresar se como una función de transferencia, en el dominio $z$. Usando potencias positivas se tiene:

\begin{equation}
    H(z) = \frac{b_0z^m+b_1z^{m-1}+...+b_{m-1}z+b_m}{a_0z^n+a_1z^{n-1}+...+a_{n-1}z+a_n}
\end{equation}



Al igual que para el caso análogo, se puede disminuir el orden usando fracciones parciales. Resultado usando potencias positivas:
\begin{equation}
    H(z) = k(z) + \frac{r_2}{z-p_1} + \frac{r_2}{z-p_2} + ... + \frac{r_{N-1}}{z-p_{N-1}} + \frac{r_N}{z-p_N}
\end{equation}

\subsection{Filtros FIR}
La función de transferencia de un filtro FIR es un polinomio, o con denominador igual a 1. Esto impide realizar fracciones de orden que nos permitirían diminuir el orden del filtro.

\subsection{Aplicación en Matlab}
Para calcular fracciones parciales basta con usar la función residue(numerador, denominador). Así se obtienen los residuos, polos y ganancias que luego podrán ser mostrados.
\begin{lstlisting}[language=MATLAB]
 [r, p, k] = residue(numerador, denominador);
\end{lstlisting}





\subsection{Guardado de Resultado}

La señal procesada se guarda en formato WAV, a continuacion se presenta un ejemplo si se usara el sistema con filtros IIR de transformacion bilineal:

\begin{lstlisting}[language=MATLAB]
audiowrite('Audio_Ecualizado_IIR.wav', senal_normalizada, Fs);
\end{lstlisting}

% Pilas: Indicar qué sistema se utilizó para la salida final (Analógico/IIR/FIR)

\end{document}
